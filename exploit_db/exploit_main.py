# exploitdb_main.py
import os
from dotenv import load_dotenv

load_dotenv()

from extract import extract_exploit_csv_text
from transform import transform_csv_text_to_records_and_json_bytes
from load import sync_exploit_records_to_dynamodb_and_s3

def main():
    print("ðŸš€ Starting ExploitDB ETL pipeline")

    cfg = {
        "S3_BUCKET": os.getenv("S3_BUCKET"),
        "S3_PREFIX": os.getenv("S3_PREFIX", "vuln-raw-source/exploitdb/"),
        "AWS_REGION": os.getenv("AWS_REGION", "us-east-1"),
        "AWS_ACCESS_KEY_ID": os.getenv("AWS_ACCESS_KEY_ID"),
        "AWS_SECRET_ACCESS_KEY": os.getenv("AWS_SECRET_ACCESS_KEY"),
        "BASELINE_FILENAME": os.getenv("BASELINE_FILENAME", "exploit_baseline.json"),
        "BATCH_PROGRESS_INTERVAL": int(os.getenv("BATCH_PROGRESS_INTERVAL", "500")),
        "TABLE_NAME": "infoservices-cybersecurity-vuln-exploitdb-data",
    }

    if not cfg["S3_BUCKET"]:
        raise RuntimeError("S3_BUCKET must be set in environment or .env")

    csv_text = extract_exploit_csv_text()
    records, json_bytes = transform_csv_text_to_records_and_json_bytes(csv_text)
    summary = sync_exploit_records_to_dynamodb_and_s3(records, json_bytes, cfg)

    print("âœ… ETL finished successfully.")
    return summary


if __name__ == "__main__":
    main()
